name: GSA Link Checker

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: "0 9 * * 1"  # Run every Monday at 9 AM UTC
  push:
    paths:
      - 'gsa-urls.txt'  # Run when URL list is updated
      - '.github/workflows/linkchecker.yml'  # Run when this workflow is updated

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run lychee link checker
        id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          # Input file containing URLs to check
          args: '--verbose --no-progress --format markdown --timeout 30 --max-retries 3 --accept 200,201,202,203,204,301,302,303,307,308 gsa-urls.txt'
          # Don't fail the workflow on broken links
          fail: false
          # Output format
          format: markdown
          # Job summary
          jobSummary: true
          
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-checker-results
          path: lychee/out.md
          retention-days: 30
          
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”— Link Checker Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked GSA Drupal nodes for broken links." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "lychee/out.md" ]; then
            cat lychee/out.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No broken links found! âœ…" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Summary:** ${{ steps.lychee.outputs.exit_code == 0 && 'âœ… All links are valid' || 'âš ï¸ Some links need attention' }}" >> $GITHUB_STEP_SUMMARY