name: Scan for broken links

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1'

jobs:
  link-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Install muffet
        run: |
          curl -sSL https://github.com/raviqqe/muffet/releases/latest/download/muffet_linux_amd64.tar.gz | tar xz
          chmod +x muffet

      - name: Crawl site and check links
        run: |
          ./muffet https://www.gsa.gov/technology/it-contract-vehicles-and-purchasing-programs \
            --header "User-Agent: ITC-LinkChecker/1.0 (internal bot; +https://github.com/GSA/itvmo)" \
            --buffer-size 8192 \
            --max-connections 10 \
            --timeout 30 \
            --exclude 'linkedin\.com' \
            --exclude 'twitter\.com' \
            --exclude 'x\.com' \
            --exclude 'facebook\.com' \
            --exclude 'mailto:' \
            2>&1 | tee link-report.txt || true

      - name: Generate summary grouped by parent URL
        run: |
          echo "## Link Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "^https\?://" link-report.txt; then
            echo "### Broken Links Found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract unique parent URLs and sort them
            grep "^https\?://" link-report.txt | awk -F' ' '{print $1}' | sort -u | while read parent_url; do
              echo "#### ðŸ“„ \`$parent_url\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              # Find all broken links on this page
              grep "^$parent_url " link-report.txt | awk -F' ' '{$1=""; print "- " $0}' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âœ… No broken links found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: link-report.txt
          retention-days: 30
